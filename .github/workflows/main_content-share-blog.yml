name: Deploy to Azure

on:
  push:
    branches: ["main"]

  workflow_dispatch:

permissions:
  id-token: write 
  contents: read 

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 
        uses: actions/checkout@v3

      - name: Setup Node 
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies 
        run: |
          npm install

      - name: Login to Azure Subscription 
        uses: azure/login@v2
        with:
            client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_FCDE7D3D05554448A21B1C97EDA0149A }}
            tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_84B6F3DEF4B74259AFC6E61E2C821B96 }}
            subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_9163DF7E7B1F483EAE0D27568F4EF1BD }}

      - name: Build Next.js app
        run: |
          npm run build
          mv .next/static .next/standalone/.next/static
          # mv public .next/standalone/public

      - name: Deploy
        shell: pwsh
        run: |
              $ZIP_FILE_NAME = "./${FILE_NAME}.zip"
              zip $ZIP_FILE_NAME ./* .next -qr
  
              az webapp deploy `
                  --resource-group $RESOURCE_GROUP_NAME `
                  --name $WEB_APP_NAME `
                  --src-path $ZIP_FILE_NAME `
                  --slot staging `
                  --type zip `
                  --clean true 
        env:
            FILE_NAME: "azure-webapp"
            RESOURCE_GROUP_NAME: "content-share-app-resources"
            WEB_APP_NAME: "content-share-blog"
